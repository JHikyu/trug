#!/usr/bin/env node
const http=require("http"),url=require("url"),fs=require("fs"),path=require("path"),argv=require("minimist")(process.argv.slice(2)),colors=require("colors"),ejs=require("ejs"),pug=require("pug"),PORT=!isNaN(argv.port)&&(argv.port||argv.p)||80,PROJECT_PATH=argv.path||".";function fileExtension(e){return fs.existsSync(e+".pug")?"pug":fs.existsSync(e+".html")?"html":fs.existsSync(e+".ejs")?"ejs":void 0}function log(e){console.log("[LOG]".bgGray,e.grey)}async function fromDir(e,n){if(fs.existsSync(e))for(var i=fs.readdirSync(e),t=0;t<i.length;t++){var r=path.join(e,i[t]);(await fs.lstatSync(r)).isDirectory()?fromDir(r,n):0<=r.indexOf(n)&&(log("watching "+r),fs.watchFile(path.resolve(r),()=>{log(r+" changed"),delete require.cache[path.resolve(r)]}))}}log("Booting Trug 🧺 in "+PROJECT_PATH),log("Checking project folders..."),log(`views folder: ${PROJECT_PATH}/views `+(fs.existsSync(PROJECT_PATH+"/views")?"✓":"✗")),log(`public folder: ${PROJECT_PATH}/public `+(fs.existsSync(PROJECT_PATH+"/public")?"✓":"✗")),log(`src folder: ${PROJECT_PATH}/src `+(fs.existsSync(PROJECT_PATH+"/src")?"✓":"✗")),fs.existsSync(PROJECT_PATH+"/views")&&fs.existsSync(PROJECT_PATH+"/public")&&fs.existsSync(PROJECT_PATH+"/src")||(log("Project not setup correctly. Please run ".red+"`trug init`".yellow+" to setup your project.".red),process.exit(1)),http.createServer(async(i,t)=>{const r=url.parse(i.url,!0)["pathname"];var n=path.join(PROJECT_PATH,"views",r,"/"===r?"index":"");if("/favicon.ico"===r&&fs.existsSync(path.join(PROJECT_PATH,"public","favicon.ico")))return t.setHeader("Content-Type","image/x-icon"),void fs.createReadStream(path.join(PROJECT_PATH,"public","favicon.ico")).pipe(t);log(`request on ${r} checking `+n);const o=fileExtension(n)??fileExtension(path.join(n,"index"));var e=!fileExtension(n);if(!o)return log((r+" not found").underline),t.writeHead(404,{"Content-Type":"text/plain"}),void t.end(`Cannot ${i.method} `+i.url);const s=n+(e?"\\index":"")+"."+o;log((s+" found").underline);n+=e?"\\index":"";let l;if(fs.existsSync(n+".js")){try{l=await require(path.resolve(n+".js"))()}catch(e){log(`Error running script ${n}.js`.red),log(e.stack.red)}log((n+" found").underline)}fs.readFile(s,(e,n)=>e?(log((r+" not found").underline),t.writeHead(404,{"Content-Type":"text/plain"}),void t.end(`Cannot ${i.method} `+i.url)):(t.writeHead(200,{"Content-Type":"text/html"}),void("pug"===o?(fn=pug.compile(n,{filename:s,pretty:!0}),t.end(fn(l?.data))):"ejs"===o?(fn=ejs.compile(s.toString()),t.end(fn(l.data))):"html"===o?t.end(n):t.end(""))))}).listen(PORT,()=>{console.log(`Trug 🧺 is running on port ${PORT} 👍`.green.bold)}),(async()=>{fromDir(path.join(PROJECT_PATH),".js")})();