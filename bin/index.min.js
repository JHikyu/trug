#!/usr/bin/env node
const http=require("http"),url=require("url"),fs=require("fs"),path=require("path"),argv=require("minimist")(process.argv.slice(2)),colors=require("colors"),ejs=require("ejs"),pug=require("pug"),PORT=!isNaN(argv.port)&&(argv.port||argv.p)||80,PROJECT_PATH=argv.path||".";function fileExtension(e){return fs.existsSync(e+".pug")?"pug":fs.existsSync(e+".html")?"html":fs.existsSync(e+".ejs")?"ejs":void 0}function log(e){console.log("[LOG]".bgGray,e.grey)}log("Booting Trug 🧺 in "+PROJECT_PATH),log("Checking project folders..."),log(`views folder: ${PROJECT_PATH}/views `+(fs.existsSync(PROJECT_PATH+"/views")?"✓":"✗")),log(`public folder: ${PROJECT_PATH}/public `+(fs.existsSync(PROJECT_PATH+"/public")?"✓":"✗")),log(`src folder: ${PROJECT_PATH}/src `+(fs.existsSync(PROJECT_PATH+"/src")?"✓":"✗")),fs.existsSync(PROJECT_PATH+"/views")&&fs.existsSync(PROJECT_PATH+"/public")&&fs.existsSync(PROJECT_PATH+"/src")||(log("Project not setup correctly. Please run ".red+"`trug init`".yellow+" to setup your project.".red),process.exit(1)),http.createServer(async(n,i)=>{const r=url.parse(n.url,!0)["pathname"];var t=path.join(PROJECT_PATH,"views",r,"/"===r?"index":"");if("/favicon.ico"===r&&fs.existsSync(path.join(PROJECT_PATH,"public","favicon.ico")))return i.setHeader("Content-Type","image/x-icon"),void fs.createReadStream(path.join(PROJECT_PATH,"public","favicon.ico")).pipe(i);log(`request on ${r} checking `+t);const o=fileExtension(t)??fileExtension(path.join(t,"index"));var e=!fileExtension(t);if(!o)return fs.existsSync(path.join(PROJECT_PATH,"public",r))?(log(`serving ${r} from public folder`),i.setHeader("Content-Type","text/html"),void fs.createReadStream(path.join(PROJECT_PATH,"public",r)).pipe(i)):(log((r+" not found").underline),i.writeHead(404,{"Content-Type":"text/plain"}),void i.end(`Cannot ${n.method} `+n.url));const s=t+(e?"\\index":"")+"."+o;log((s+" found").underline);t+=e?"\\index":"";let l;if(fs.existsSync(t+".js")){try{l=await require(path.resolve(t+".js"))()}catch(e){log(`Error running script ${t}.js`.red),log(e.stack.red)}log((t+" found").underline)}fs.readFile(s,(e,t)=>e?(log((r+" not found").underline),i.writeHead(404,{"Content-Type":"text/plain"}),void i.end(`Cannot ${n.method} `+n.url)):(i.writeHead(200,{"Content-Type":"text/html"}),void("pug"===o?(fn=pug.compile(t,{filename:s,pretty:!0}),i.end(fn(l?.data))):"ejs"===o?(fn=ejs.compile(s.toString()),i.end(fn(l.data))):"html"===o?i.end(t):i.end(""))))}).listen(PORT,()=>{console.log(`Trug 🧺 is running on port ${PORT} 👍`.green.bold)}),async function e(t,n){if(fs.existsSync(t))for(var i=fs.readdirSync(t),r=0;r<i.length;r++){var o=path.join(t,i[r]);(await fs.lstatSync(o)).isDirectory()?e(o,n):o.endsWith(n)&&(log("watching "+o),fs.watchFile(path.resolve(o),()=>{log((o+" changed").yellow),delete require.cache[path.resolve(o)]}))}}(path.join(PROJECT_PATH),".js");