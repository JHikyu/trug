#!/usr/bin/env node
const http=require("http"),url=require("url"),fs=require("fs"),path=require("path"),argv=require("minimist")(process.argv.slice(2)),colors=require("colors"),ejs=require("ejs"),pug=require("pug"),PORT=!isNaN(argv.port)&&(argv.port||argv.p)||80,PROJECT_PATH=argv.path||".";function nocache(e){fs.watchFile(path.resolve(e),()=>{delete require.cache[require.resolve(e)]})}function fileExtension(e){return fs.existsSync(e+".pug")?"pug":fs.existsSync(e+".html")?"html":fs.existsSync(e+".ejs")?"ejs":void 0}function log(e){console.log("[LOG]".bgGray,e.grey)}log("Booting Trug ğŸ§º in "+PROJECT_PATH),log("Checking project folders..."),log(`views folder: ${PROJECT_PATH}/views `+(fs.existsSync(PROJECT_PATH+"/views")?"âœ…":"âŒ")),log(`public folder: ${PROJECT_PATH}/public `+(fs.existsSync(PROJECT_PATH+"/public")?"âœ…":"âŒ")),log(`src folder: ${PROJECT_PATH}/src `+(fs.existsSync(PROJECT_PATH+"/src")?"âœ…":"âŒ")),fs.existsSync(PROJECT_PATH+"/views")&&fs.existsSync(PROJECT_PATH+"/public")&&fs.existsSync(PROJECT_PATH+"/src")||(log("Project not setup correctly. Please run ".red+"`trug init`".blue+" to setup your project.".red),process.exit(1)),http.createServer(async(t,r)=>{const i=url.parse(t.url,!0)["pathname"];var n=path.join(PROJECT_PATH,"views",i,"/"===i?"index":"");if("/favicon.ico"===i&&fs.existsSync(path.join(PROJECT_PATH,"public","favicon.ico")))return r.setHeader("Content-Type","image/x-icon"),void fs.createReadStream(path.join(PROJECT_PATH,"public","favicon.ico")).pipe(r);log(`request on ${i} checking `+n);const o=fileExtension(n)??fileExtension(path.join(n,"index"));var e=!fileExtension(n);if(!o)return log((i+" not found").underline),r.writeHead(404,{"Content-Type":"text/plain"}),void r.end(`Cannot ${t.method} `+t.url);const s=n+(e?"\\index":"")+"."+o;log((s+" found").underline);n+=e?"\\index":"";let l;if(fs.existsSync(n+".js")){nocache(path.resolve(n+".js"));try{l=await require(path.resolve(n+".js"))()}catch(e){log(`Error running script ${n}.js`.red),log(e.stack.red)}log((n+" found").underline)}fs.readFile(s,(e,n)=>e?(log((i+" not found").underline),r.writeHead(404,{"Content-Type":"text/plain"}),void r.end(`Cannot ${t.method} `+t.url)):(r.writeHead(200,{"Content-Type":"text/html"}),void("pug"===o?(fn=pug.compile(n,{filename:s,pretty:!0}),r.end(fn(l?.data))):"ejs"===o?(fn=ejs.compile(s.toString()),r.end(fn(l.data))):"html"===o?r.end(n):r.end(""))))}).listen(PORT,()=>{console.log(`Trug ğŸ§º is running on port ${PORT} ğŸ‘`.green.bold)});